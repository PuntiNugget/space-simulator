<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Galaxy Simulator</title>

    <style>
        /* Basic page setup */
        body {
            background-color: #00001a;
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            text-align: center;
        }

        .main-layout-container {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 20px;
        }

        /* The main container for the simulation */
        .solar-system-container {
            position: relative;
            width: 600px;
            height: 600px;
            display: grid;
            place-items: center;
            border: 1px dashed #333;
            overflow: hidden;
            background-color: #00000a; /* Slightly darker inner space */
            cursor: default; /* Default cursor */
        }
        
        #universe {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        /* Tool Styles */
        .tools {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .tool-btn {
            padding: 10px;
            font-size: 24px;
            background-color: #333;
            color: white;
            border: 2px solid #555;
            border-radius: 5px;
            cursor: pointer;
        }
        .tool-btn.active {
            background-color: #fcdc4c;
            color: #000;
            border-color: #fff;
        }

        /* === Body Styles === */
        .celestial-body {
            position: absolute;
            border-radius: 50%;
        }

        .star {
            background-color: #fcdc4c;
        }
        
        .black-hole {
            background-color: #000;
            border: 2px solid #333;
            box-shadow: 0 0 20px #ff8c00, 0 0 30px #ff4500;
        }

        .planet {
            background-color: #3d91f0;
        }
        
        /* Gravity Indicator Style */
        .gravity-indicator {
            position: absolute;
            border: 2px dotted rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.1s linear, width 0.1s linear, height 0.1s linear;
        }

        
        /* === UI Form Styles === */
        .controls-panel-left,
        .controls-panel-right {
            width: 280px;
            background-color: #1a1a2a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
        }
        fieldset {
            border: 1px solid #555;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        legend {
            color: #fcdc4c;
            font-weight: bold;
        }
        input, select, button {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #777;
            background-color: #333;
            color: white;
            width: 95%;
        }
        label > input {
            width: 100%;
            box-sizing: border-box;
        }
        button {
            cursor: pointer;
            background-color: #fcdc4c;
            color: #000;
            font-weight: bold;
        }
        button:hover {
            background-color: #fff;
        }
        
        /* Sim Control Styles */
        .sim-controls {
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            align-items: center;
        }
        .sim-controls button {
            width: 50px;
            font-size: 1.2em;
        }
        .sim-controls span {
            width: 100px;
            text-align: center;
            color: #fcdc4c;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h1>Physics Galaxy Simulator</h1>

    <div class="main-layout-container">

        <div class="controls-panel-left">
            <fieldset>
                <legend>Tools</legend>
                <div class="tools">
                    <button class="tool-btn active" id="tool-select" title="Select / Move">üëÜ</button>
                    <button class="tool-btn" id="tool-pan" title="Pan View">‚úã</button>
                    <button class="tool-btn" id="tool-picker" title="Picker / Duplicate">üß™</button>
                </div>
            </fieldset>

            <fieldset>
                <legend>Add Celestial Body</legend>
                <select id="body-type">
                    <option value="star">Star</option>
                    <option value="black-hole">Black Hole</option>
                    <option value="planet">Planet</option>
                </select>
                
                <input type="number" id="body-mass" placeholder="Mass (e.g., Star: 1000)">
                <input type="number" id="body-size" placeholder="Size (px, e.g., 20)">
                
                <label id="color-field">
                    Color:
                    <input type="text" id="body-color" placeholder="e.g., #ff0000">
                </label>
                
                <label id="orbit-field" style="display: none;">
                    Orbit Distance:
                    <input type="number" id="orbit-distance" placeholder="e.g., 100">
                </label>
                
                <button id="add-body-btn">Add Body</button>
            </fieldset>
        </div>

        <div class="solar-system-container">
            <div id="universe">
                </div>
        </div>

        <div class="controls-panel-right">

            <fieldset>
                <legend>Simulation Control</legend>
                <div class="sim-controls">
                    <button id="slow-down-btn" title="Slow Down">&lt;&lt;</button>
                    <button id="pause-btn" title="Pause">‚ùö‚ùö</button>
                    <button id="speed-up-btn" title="Speed Up">&gt;&gt;</button>
                    <span id="speed-display">Speed: 1.0x</span>
                </div>
            </fieldset>

            <fieldset>
                <legend>Manage Galaxies</legend>
                <input type="text" id="galaxy-name" placeholder="Galaxy Name">
                <button id="save-galaxy-btn">Save</button>
                <select id="load-galaxy-menu"></select>
                <button id="load-galaxy-btn">Load</button>
                <button id="clear-galaxy-btn">Clear All</button>
            </fieldset>
            
            <fieldset id="selection-info" style="display: none;">
                <legend>Selection Info</legend>
                <div id="selection-name" style="margin-bottom: 10px;"></div>
                <button id="delete-btn" style="background-color: #c1440e;">Delete Body</button>
            </fieldset>
        </div>

    </div> <script>
        document.addEventListener('DOMContentLoaded', () => {

            // === 1. GET ALL DOM ELEMENTS ===
            const container = document.querySelector('.solar-system-container');
            const universe = document.getElementById('universe');
            const toolSelectBtn = document.getElementById('tool-select');
            const toolPanBtn = document.getElementById('tool-pan');
            const toolPickerBtn = document.getElementById('tool-picker');
            const addBodyBtn = document.getElementById('add-body-btn');
            const bodyTypeSelect = document.getElementById('body-type');
            const bodyMassInput = document.getElementById('body-mass');
            const bodySizeInput = document.getElementById('body-size');
            const bodyColorInput = document.getElementById('body-color');
            const orbitDistInput = document.getElementById('orbit-distance');
            const colorField = document.getElementById('color-field');
            const orbitField = document.getElementById('orbit-field');
            const saveGalaxyBtn = document.getElementById('save-galaxy-btn');
            const loadGalaxyBtn = document.getElementById('load-galaxy-btn');
            const clearGalaxyBtn = document.getElementById('clear-galaxy-btn');
            const loadGalaxyMenu = document.getElementById('load-galaxy-menu');
            const selectionInfoPanel = document.getElementById('selection-info');
            const selectionName = document.getElementById('selection-name');
            const deleteBtn = document.getElementById('delete-btn');
            const slowDownBtn = document.getElementById('slow-down-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const speedUpBtn = document.getElementById('speed-up-btn');
            const speedDisplay = document.getElementById('speed-display');


            // === 2. CORE SIMULATION STATE ===
            let currentTool = 'select';
            let isMouseDown = false;
            let viewport = { x: 0, y: 0 };
            const G = 1; // Gravitational constant
            const PLANET_TO_STAR_MASS_THRESHOLD = 750;
            
            let currentGalaxy = {
                bodies: []
            };
            
            let bodyElements = new Map();
            let selectedBody = null;
            let isDraggingBody = false;
            let lastMousePos = { x: 0, y: 0 };
            
            let isPaused = false;
            let timeScale = 1.0;
            const timeScaleStep = 0.25;


            // === 3. THE PHYSICS & RENDER "GAME LOOP" ===
            
            function simulationLoop() {
                if (isPaused) {
                    return; // Stop the loop if paused
                }
                
                updatePhysics();
                renderGalaxy();
                requestAnimationFrame(simulationLoop);
            }

            /**
             * ** UPDATED: Physics and Collision Update **
             */
            function updatePhysics() {
                // Phase 1: Calculate all forces
                for (let i = 0; i < currentGalaxy.bodies.length; i++) {
                    const bodyA = currentGalaxy.bodies[i];
                    bodyA.fx = 0;
                    bodyA.fy = 0;
                    for (let j = 0; j < currentGalaxy.bodies.length; j++) {
                        if (i === j) continue;
                        const bodyB = currentGalaxy.bodies[j];
                        const dx = bodyB.x - bodyA.x;
                        const dy = bodyB.y - bodyA.y;
                        const distSq = (dx * dx + dy * dy) || 1;
                        const dist = Math.sqrt(distSq);
                        const force = (G * bodyA.mass * bodyB.mass) / distSq;
                        bodyA.fx += (force * dx) / dist;
                        bodyA.fy += (force * dy) / dist;
                    }
                }

                // Phase 2: Apply physics (move bodies)
                for (const body of currentGalaxy.bodies) {
                    if (body.isStatic || (isDraggingBody && selectedBody && body.id === selectedBody.id)) {
                        continue;
                    }
                    const ax = body.fx / body.mass;
                    const ay = body.fy / body.mass;
                    body.vx += ax * timeScale;
                    body.vy += ay * timeScale;
                    body.x += body.vx * timeScale;
                    body.y += body.vy * timeScale;
                }

                // Phase 3: Collision Detection & Resolution
                const bodiesToDestroy = new Set();
                
                // This is your "Density Physics" logic
                // Higher number wins collisions
                const bodyDensityType = { 'black-hole': 3, 'star': 2, 'planet': 1 };
                let supernovaEvents = [];

                for (let i = 0; i < currentGalaxy.bodies.length; i++) {
                    const bodyA = currentGalaxy.bodies[i];
                    if (bodiesToDestroy.has(bodyA.id)) continue; 

                    for (let j = i + 1; j < currentGalaxy.bodies.length; j++) {
                        const bodyB = currentGalaxy.bodies[j];
                        if (bodiesToDestroy.has(bodyB.id)) continue;

                        const dx = bodyB.x - bodyA.x;
                        const dy = bodyB.y - bodyA.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        const collisionDist = (bodyA.size / 2) + (bodyB.size / 2);

                        if (dist < collisionDist) {
                            const pA = bodyDensityType[bodyA.type];
                            const pB = bodyDensityType[bodyB.type];
                            
                            let survivor, victim;
                            
                            // ** NEW DENSITY LOGIC **
                            if (pA > pB) {
                                // A is a higher type (e.g., Black Hole vs Star)
                                survivor = bodyA; 
                                victim = bodyB;
                            } else if (pB > pA) {
                                // B is a higher type
                                survivor = bodyB;
                                victim = bodyA;
                            } else {
                                // ** SAME TYPE: Now check realistic density **
                                // Density = Mass / Area (Area is proportional to size^2)
                                const densityA = bodyA.mass / (bodyA.size * bodyA.size);
                                const densityB = bodyB.mass / (bodyB.size * bodyB.size);
                                
                                if (densityA > densityB) {
                                    survivor = bodyA;
                                    victim = bodyB;
                                } else {
                                    survivor = bodyB;
                                    victim = bodyA;
                                }
                            }
                            
                            mergeBodies(survivor, victim, bodiesToDestroy, supernovaEvents);
                        }
                    }
                }
                
                // Phase 3.5 - Process Supernovas
                if (supernovaEvents.length > 0) {
                    for (const novaStar of supernovaEvents) {
                        const blastDiameter = (novaStar.size * 1.5) + (novaStar.mass / 20);
                        const blastRadius = blastDiameter / 2;
                        
                        for (const body of currentGalaxy.bodies) {
                            if (body.type === 'planet' && !bodiesToDestroy.has(body.id)) {
                                const dx = body.x - novaStar.x;
                                const dy = body.y - novaStar.y;
                                const dist = Math.sqrt(dx * dx + dy * dy);
                                
                                if (dist <= blastRadius) {
                                    bodiesToDestroy.add(body.id);
                                }
                            }
                        }
                    }
                }
                
                // Phase 4: Clean up destroyed bodies
                if (bodiesToDestroy.size > 0) {
                    currentGalaxy.bodies = currentGalaxy.bodies.filter(body => {
                        return !bodiesToDestroy.has(body.id);
                    });
                    
                    for (const id of bodiesToDestroy) {
                        const el = bodyElements.get(id);
                        if (el) el.remove();
                        bodyElements.delete(id);
                    }
                    
                    if (selectedBody && bodiesToDestroy.has(selectedBody.id)) {
                        selectBody(null);
                    }
                }
            }
            
            /**
             * ** UPDATED: Helper function to merge two bodies **
             */
            function mergeBodies(survivor, victim, bodiesToDestroy, supernovaEvents) {
                if (survivor.type === 'black-hole') {
                    survivor.isStatic = false; // Black holes are never static after collision
                }

                const newMass = survivor.mass + victim.mass;
                survivor.vx = ((survivor.mass * survivor.vx) + (victim.mass * victim.vx)) / newMass;
                survivor.vy = ((survivor.mass * survivor.vy) + (victim.mass * victim.vy)) / newMass;
                survivor.mass = newMass;
                
                // ** UPDATED: Black holes absorb mass but don't grow in visual size **
                if (survivor.type !== 'black-hole') {
                    // Combine area (newR^2 = r1^2 + r2^2)
                    survivor.size = Math.sqrt(Math.pow(survivor.size, 2) + Math.pow(victim.size, 2));
                }
                // Black holes get more massive, but not visually bigger.
                
                bodiesToDestroy.add(victim.id);
                
                // Check for Supernova
                if (survivor.type === 'star' && victim.type === 'star') {
                    supernovaEvents.push(survivor);
                }
                
                // Check for Planet-to-Star Evolution
                if (survivor.type === 'planet' && survivor.mass >= PLANET_TO_STAR_MASS_THRESHOLD) {
                    survivor.type = 'star';
                    survivor.color = '#fcdc4c';
                }
            }

            /**
             * Renders all bodies
             */
            function renderGalaxy() {
                const viewX = -viewport.x + 300;
                const viewY = -viewport.y + 300;
                universe.style.transform = `translate(${viewX}px, ${viewY}px)`;
                
                for (const body of currentGalaxy.bodies) {
                    let el = bodyElements.get(body.id);
                    let indicatorEl;
                    
                    if (!el) {
                        el = document.createElement('div');
                        indicatorEl = document.createElement('div');
                        indicatorEl.className = 'gravity-indicator';
                        el.appendChild(indicatorEl); 
                        bodyElements.set(body.id, el);
                        universe.appendChild(el);
                    } else {
                        indicatorEl = el.querySelector('.gravity-indicator');
                    }
                    
                    el.className = 'celestial-body ' + body.type;
                    el.style.width = `${body.size}px`;
                    el.style.height = `${body.size}px`;
                    el.style.backgroundColor = body.color;

                    if (indicatorEl) {
                        const indicatorOpacity = Math.min(0.8, body.mass / 1500); 
                        const indicatorSize = (body.size * 1.5) + (body.mass / 20);
                        indicatorEl.style.width = `${indicatorSize}px`;
                        indicatorEl.style.height = `${indicatorSize}px`;
                        indicatorEl.style.opacity = indicatorOpacity;
                    }
                    
                    const elX = body.x - (body.size / 2);
                    const elY = body.y - (body.size / 2);
                    el.style.transform = `translate(${elX}px, ${elY}px)`;

                    if (selectedBody && selectedBody.id === body.id) {
                        el.style.border = '2px solid cyan';
                    } else {
                        el.style.border = 'none'; 
                        if (body.type === 'black-hole') {
                            el.style.border = '2px solid #333';
                        }
                    }
                }
            }
            
            
            // === 4. UI EVENT LISTENERS ===
            
            // --- Tool Selection ---
            function setActiveTool(tool) {
                currentTool = tool;
                toolSelectBtn.classList.remove('active');
                toolPanBtn.classList.remove('active');
                toolPickerBtn.classList.remove('active');
                document.getElementById(`tool-${tool}`).classList.add('active');
                
                if (tool === 'pan') {
                    container.style.cursor = 'grab';
                } else {
                    container.style.cursor = 'default';
                }
            }
            toolSelectBtn.onclick = () => setActiveTool('select');
            toolPanBtn.onclick = () => setActiveTool('pan');
            toolPickerBtn.onclick = () => setActiveTool('picker');

            // --- ** UPDATED: Smart Form Function ** ---
            function updateAddForm() {
                const type = bodyTypeSelect.value;
                if (type === 'star') {
                    colorField.style.display = 'block';
                    orbitField.style.display = 'none';
                    bodyMassInput.placeholder = "Mass (default: 1000)";
                    bodySizeInput.placeholder = "Size (default: 50)";
                    bodyColorInput.value = '#fcdc4c';
                } else if (type === 'black-hole') {
                    colorField.style.display = 'none';
                    orbitField.style.display = 'none';
                    // ** UPDATED: Higher default mass **
                    bodyMassInput.placeholder = "Mass (default: 20000)";
                    bodySizeInput.placeholder = "Size (default: 30)";
                    bodyColorInput.value = '#000000';
                } else if (type === 'planet') {
                    colorField.style.display = 'block';
                    orbitField.style.display = 'block';
                    bodyMassInput.placeholder = "Mass (default: 10)";
                    bodySizeInput.placeholder = "Size (default: 12)";
                    orbitDistInput.placeholder = "Orbit (default: 150)";
                    bodyColorInput.value = '#3d91f0';
                }
            }
            bodyTypeSelect.addEventListener('change', updateAddForm);
            
            
            // --- ** UPDATED: Add Body Listener (with defaults) ** ---
            addBodyBtn.addEventListener('click', () => {
                const type = bodyTypeSelect.value;
                const rawMass = bodyMassInput.value;
                const rawSize = bodySizeInput.value;
                const rawColor = bodyColorInput.value;
                const rawOrbitDist = orbitDistInput.value;

                let newBody = {
                    id: Date.now(),
                    type: type,
                    x: 0, y: 0, vx: 0, vy: 0, fx: 0, fy: 0,
                    isStatic: false
                };

                if (type === 'star') {
                    newBody.mass = parseFloat(rawMass) || 1000;
                    newBody.size = parseFloat(rawSize) || 50;
                    newBody.color = rawColor || '#fcdc4c';
                    newBody.isStatic = (currentGalaxy.bodies.length === 0);
                } else if (type === 'black-hole') {
                    // ** UPDATED: Higher default mass **
                    newBody.mass = parseFloat(rawMass) || 20000;
                    newBody.size = parseFloat(rawSize) || 30;
                    newBody.color = '#000000';
                    newBody.isStatic = (currentGalaxy.bodies.length === 0);
                } else if (type === 'planet') {
                    newBody.mass = parseFloat(rawMass) || 10;
                    newBody.size = parseFloat(rawSize) || 12;
                    newBody.color = rawColor || '#3d91f0';
                    newBody.isStatic = false;
                    
                    if (currentGalaxy.bodies.length > 0) {
                        const centralBody = currentGalaxy.bodies[0];
                        const orbitDist = parseFloat(rawOrbitDist) || 150;
                        newBody.x = centralBody.x + orbitDist;
                        newBody.y = centralBody.y;
                        const v = Math.sqrt((G * centralBody.mass) / orbitDist);
                        newBody.vy = -v;
                    }
                }
                
                currentGalaxy.bodies.push(newBody);
                bodyMassInput.value = '';
                bodySizeInput.value = '';
                orbitDistInput.value = '';
                updateAddForm();
            });

            // --- Save/Load Functions ---
            saveGalaxyBtn.addEventListener('click', () => {
                const galaxyName = document.getElementById('galaxy-name').value;
                if (!galaxyName) return alert('Please enter a name!');
                const saveData = { bodies: currentGalaxy.bodies, viewport: viewport };
                localStorage.setItem(galaxyName, JSON.stringify(saveData));
                alert(`Galaxy "${galaxyName}" saved!`);
                populateLoadMenu();
            });
            loadGalaxyBtn.addEventListener('click', () => {
                const galaxyName = loadGalaxyMenu.value;
                if (!galaxyName) return alert('Please select a galaxy.');
                const savedData = JSON.parse(localStorage.getItem(galaxyName));
                clearAll(); 
                currentGalaxy.bodies = savedData.bodies;
                viewport = savedData.viewport || { x: 0, y: 0 };
                alert(`Galaxy "${galaxyName}" loaded!`);
            });
            clearGalaxyBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear the current galaxy?')) {
                    clearAll();
                }
            });
            function clearAll() {
                currentGalaxy.bodies = [];
                universe.innerHTML = '';
                bodyElements.clear();
                viewport = { x: 0, y: 0 };
                selectBody(null);
            }
            function populateLoadMenu() {
                loadGalaxyMenu.innerHTML = '';
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key;
                    loadGalaxyMenu.appendChild(option);
                }
            }
            
            // --- Selection Panel Logic ---
            deleteBtn.addEventListener('click', () => {
                if (selectedBody) {
                    const bodiesToDestroy = new Set([selectedBody.id]);
                    currentGalaxy.bodies = currentGalaxy.bodies.filter(body => {
                        return !bodiesToDestroy.has(body.id);
                    });
                    const el = bodyElements.get(selectedBody.id);
                    if (el) el.remove();
                    bodyElements.delete(selectedBody.id);
                    selectBody(null);
                }
            });
            
            function selectBody(body) {
                selectedBody = body;
                if (body) {
                    selectionInfoPanel.style.display = 'block';
                    selectionName.textContent = `${body.type} (Mass: ${body.mass.toFixed(0)})`;
                } else {
                    selectionInfoPanel.style.display = 'none';
                    selectionName.textContent = '';
                }
            }

            function findBodyAt(x, y) {
                for (let i = currentGalaxy.bodies.length - 1; i >= 0; i--) {
                    const body = currentGalaxy.bodies[i];
                    const dx = body.x - x;
                    const dy = body.y - y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < body.size / 2) {
                        return body;
                    }
                }
                return null;
            }

            
            // === 5. MOUSE CONTROLS (with Pan/Drag/Picker) ===
            
            function getUniverseCoords(e) {
                const rect = container.getBoundingClientRect();
                const screenX = e.clientX - rect.left;
                const screenY = e.clientY - rect.top;
                const universeX = (screenX - 300) + viewport.x;
                const universeY = (screenY - 300) + viewport.y;
                return { x: universeX, y: universeY };
            }
            
            container.addEventListener('mousedown', (e) => {
                isMouseDown = true;
                lastMousePos = { x: e.clientX, y: e.clientY };
                const coords = getUniverseCoords(e);
                
                if (currentTool === 'select') {
                    const clickedBody = findBodyAt(coords.x, coords.y);
                    selectBody(clickedBody);
                    if (clickedBody) {
                        isDraggingBody = true;
                        clickedBody.vx = 0;
                        clickedBody.vy = 0;
                    }
                } else if (currentTool === 'pan') {
                    container.style.cursor = 'grabbing';
                } else if (currentTool === 'picker') {
                    const clickedBody = findBodyAt(coords.x, coords.y);
                    if (clickedBody) {
                        const newBody = JSON.parse(JSON.stringify(clickedBody));
                        newBody.id = Date.now(); 
                        newBody.x += newBody.size; 
                        newBody.isStatic = false; 
                        currentGalaxy.bodies.push(newBody);
                    }
                }
            });
            
            container.addEventListener('mousemove', (e) => {
                if (!isMouseDown) return;

                const newMousePos = { x: e.clientX, y: e.clientY };
                const deltaX = newMousePos.x - lastMousePos.x;
                const deltaY = newMousePos.y - lastMousePos.y;
                
                if (currentTool === 'pan') {
                    viewport.x -= deltaX;
                    viewport.y -= deltaY;
                } else if (currentTool === 'select' && isDraggingBody && selectedBody) {
                    const coords = getUniverseCoords(e);
                    selectedBody.x = coords.x;
                    selectedBody.y = coords.y;
                    selectedBody.vx = 0;
                    selectedBody.vy = 0;
                }
                
                lastMousePos = newMousePos;
            });
            
            container.addEventListener('mouseup', () => {
                isMouseDown = false;
                if (currentTool === 'pan') {
                    container.style.cursor = 'grab';
                }
                if (isDraggingBody) {
                    isDraggingBody = false;
                }
            });
            
            container.addEventListener('mouseleave', () => {
                isMouseDown = false;
                isDraggingBody = false;
                if (currentTool === 'pan') {
                    container.style.cursor = 'grab';
                }
            });
            
            
            // --- Simulation Control Listeners ---
            
            pauseBtn.addEventListener('click', () => {
                isPaused = !isPaused; // Toggle the pause state
                if (isPaused) {
                    pauseBtn.innerHTML = '‚ñ∫'; // Show 'Play' icon
                    pauseBtn.title = 'Resume';
                } else {
                    pauseBtn.innerHTML = '‚ùö‚ùö'; // Show 'Pause' icon
                    pauseBtn.title = 'Pause';
                    requestAnimationFrame(simulationLoop);
                }
            });
            
            speedUpBtn.addEventListener('click', () => {
                timeScale += timeScaleStep;
                updateSpeedDisplay();
            });
            
            slowDownBtn.addEventListener('click', () => {
                if (timeScale > timeScaleStep) { 
                    timeScale -= timeScaleStep;
                } else {
                    timeScale = timeScaleStep; // Set to min
                }
                updateSpeedDisplay();
            });
            
            function updateSpeedDisplay() {
                speedDisplay.textContent = `Speed: ${timeScale.toFixed(2)}x`;
            }


            // === 6. START THE SIMULATOR ===
            populateLoadMenu();
            updateAddForm(); // Set the initial form defaults
            requestAnimationFrame(simulationLoop); // Start the game loop!
        });
    </script>

</body>
</html>
